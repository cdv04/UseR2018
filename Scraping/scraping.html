<!DOCTYPE html>
<html>
  <head>
    <title>Part 1. Web Scraping</title>
    <meta charset="utf-8">
    <meta name="author" content="useR 2018" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="duke_color_pallettes_slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Part 1. Web Scraping
## Statistical Models for Sport in R
### useR 2018

---






# About Me

- Senior Data Scientist for Tennis Australia's Game Insight Group

- Research Fellow at Victoria University

- Tennis Blogger at [on-the-t.com](on-the-t.com)

- @StatsOnTheT


---


# Tutorial Resources

- Github: [github.com/skoval/satRday](github.com/skoval/satRday)

- Contact: [s.a.kovalchik@gmail.com](s.a.kovalchik@gmail.com)

---

# Tutorial Outline

Part 1. Web scraping

--

&lt;i&gt;SOME MODELS FOR SPORTS DATA&lt;/i&gt;

Part 2. Pythagorean Expectation

Part 3. Paired Comparisons

Part 4. GAM

Part 5. Forecasting with Bayes


---

# Ways of Getting Sports Data

As a sports statistician you will often need to gather data from the Web. Here are some common ways to get these data:

--

- Importing a data file directly from a Website

--

- Scraping from the underlying source code, which can come in two basic flavors:

  1. Extraction from HTML for static data
  
  2. Importing the underlying data objects for dynamic pages (if possible)
  
  3. Extraction through automated browsing for data that is generated dynamically

---



# Import Data File

--

- Some sites, like [Baseball-Reference.com](http://www.baseball-reference.com), provide tools for creating exportable reports.

--

- In general, we want to avoid manual data collection and automate wherever possible because: *automation = efficiency*

--

- Sports data that is on the Web as an importable file can be imported with `read.table` or similar import function in R if we can determine it's URL

---



# Import Data File

- What are "importable" files? 

--

- Common types include:

--

  - txt
  - csv
  - xls
  - Anything else you can read with `read.table` or specialty imports
  

---



# Example: Import Data File

Here we extract the most recent Australian Open match results and betting odds using `read.csv`.


```r
url &lt;- "http://www.tennis-data.co.uk/2017/ausopen.csv"

read.csv(url)
```

---



# Practice: Import Data File

How do you think you would obtain the same data from the last US Open? 

--

1. Give it a try.

2. Read in the data.

3. Determine the number of matches included.

---



# Solution: Import Data File



```r
url &lt;- "http://www.tennis-data.co.uk/2016/usopen.csv"

usopen &lt;- read.csv(url)

nrow(usopen) # Number of matches
```

```
## [1] 127
```

---



# Web Scraping

.cbox[
### More often you will need to go "under the hood" and work directly with HTML/CSS to extract data from Websites.
]

---


# Inspecting Web Pages


- Before you can extract the data, you need to understand the site design and how the data is contained in it

--

- This means getting familiar with "View Source" and "Developer Tools"

--

- I would recommend getting the "Developer" add-in with Google Chrome, which has an array of tools for inspecting the contents of Web Sites

---



# Viewing Source in Chrome

![](view-source.png)

---



# Practice: Import Data File

1. Navigate to http://www.basketball-reference.com/

2. Use 'View Source' to find where the stats for the 'NBA Standings' are located

3. What is the "id" associated with these data?


---



# Static vs Dynamic Data

.cbox[
### Understanding which tools you need to extract data from a Web site starts with determining if the data is _statically_ or _dynamically_ generated on the site.
]

&lt;br&gt;

Web data is _static_ if you can see it in the source code. If it isn't there, it's _dynamic_.


---

# Practice: Static or Dynamic Data?

1. Have a look at the Tennis Elo Ratings info at the following site:
http://tennisabstract.com/reports/atp_elo_ratings.html

2. Use View Source to determine if the Elo Ratings data are _static_ or _dynamic_.

---

# Solution: It's Static

![](tennis_elo_ratings.png)


---

# Practice: Static or Dynamic Data?

1. Now have a look at another _Tennis Astract_ page with stats on Roger Federer:
http://www.tennisabstract.com/cgi-bin/player.cgi?p=RogerFederer

2. Use View Source to determine if the Elo Ratings data are _static_ or _dynamic_.



---

# Solution: It's Dynamic

![](tennis_abstract_federer.png)

---



# Scraping Static Data

There are a few options for extracting static HTML data.

1. `readLines` is an option if the data is _not_ nicely formatted, in other words, when there is a lack of structure

2. More typically, the data is _nice_ (e.g. if it is contained in a HTML table or other predictable tag) and we can use scraping packages like `rvest` or `RCurl` to get the data in a format we can work with.

---



# Using `rvest`

--

- Suite of tools for scraping static Web data and putting them in easy-to-use objects (like data.frames)

--

- Works with `magrittr` and allows piping commands with `%&gt;%` operator

--

- Allows some browsing functionality

--

- Authored by Hadley Wickham

---



# Example: Scraping Box Scores

In this example, we will use `rvest` to extract the Eastern Division Standings.

First, we import the page content.


```r
library('rvest')

# Creating object with the address
url &lt;- 'http://www.basketball-reference.com/boxscores/'

#Reading the code from the site
webpage &lt;- read_html(url)
```

---



# Example: Scraping Box Scores

The `html_nodes` function is the work horse function for extracting specific elements of a site. We can specify the element we want using its CSS tag or using an XPATH selector.


```r
# Using the CSS table tag to get all tables
data &lt;- webpage %&gt;%
   html_nodes(css = 'table') %&gt;%
   html_table()

length(data) # List of multiple tables
```

```
## [1] 7
```


---



# Example: Scraping Box Scores

Using an XPATH ([XML Path Language](https://en.wikipedia.org/wiki/XPath)) can help to make our extraction more specific, though the syntax is more opaque. 


```r
# Using an XPATH selector to get the specific table of interest
data &lt;- webpage %&gt;%
   html_nodes(xpath = '//*[@id="divs_standings_E"]') %&gt;%
   html_table(header = T)

head(data[[1]])
```

```
##    Eastern Conference                 W                 L
## 1   Atlantic Division Atlantic Division Atlantic Division
## 2    Toronto Raptors*                59                23
## 3     Boston Celtics*                55                27
## 4 Philadelphia 76ers*                52                30
## 5     New York Knicks                29                53
## 6       Brooklyn Nets                28                54
##                W/L%                GB              PS/G              PA/G
## 1 Atlantic Division Atlantic Division Atlantic Division Atlantic Division
## 2              .720                 —             111.7             103.9
## 3              .671               4.0             104.0             100.4
## 4              .634               7.0             109.8             105.3
## 5              .354              30.0             104.5             108.0
## 6              .341              31.0             106.6             110.3
```


---



# Practice: Static Data Extraction

Let's go back to the Elo ratings of male tennis players: [Tennis Abstract Elo](http://tennisabstract.com/reports/atp_elo_ratings.html)

--

1. Use your View Source tools to determine the element containing the ratings

2. Use `rvest` to scrape the data as efficiently as you can

---




# Solution: Elo Rating Extraction

![](tennis-elo.png)

---




# Solution: Elo Rating Extraction


```r
url &lt;- "http://tennisabstract.com/reports/atp_elo_ratings.html"

page &lt;- read_html(url)

# Use table class to extract Elo table
elo &lt;- page %&gt;%
    html_nodes("table.tablesorter") %&gt;%
    html_table()

head(elo)
```

```
## [[1]]
##     Rank                      Player  Age    Elo      Hard   Clay  Grass
## 1      1                Rafael Nadal 32.0 2222.3 NA 2011.2 2252.0 1635.8
## 2      2               Roger Federer 36.9 2150.2 NA 2064.3 1748.4 1908.0
## 3      3              Novak Djokovic 31.1 2102.6 NA 2068.4 2056.6 1940.9
## 4      4       Juan Martin Del Potro 29.7 2098.4 NA 2022.4 1869.0 1613.7
## 5      5            Alexander Zverev 21.2 2074.9 NA 1922.6 2085.2 1725.2
## 6      6                 Andy Murray 31.1 2054.1 NA 2009.3 1954.8 1839.6
## 7      7               Dominic Thiem 24.8 2020.0 NA 1804.7 2117.3 1640.9
## 8      8                 Marin Cilic 29.7 1980.7 NA 1818.2 1839.9 1875.0
## 9      9                David Goffin 27.5 1978.7 NA 1903.9 1923.7 1643.6
## 10    10               Kei Nishikori 28.5 1978.1 NA 1837.5 1977.9 1666.5
## 11    11             Grigor Dimitrov 27.1 1968.7 NA 1936.9 1784.6 1717.0
## 12    12                 Borna Coric 21.6 1966.8 NA 1835.1 1789.9 1630.2
## 13    13                Nick Kyrgios 23.1 1963.1 NA 1870.7 1635.3 1733.9
## 14    14                Milos Raonic 27.5 1948.9 NA 1850.9 1830.0 1791.4
## 15    15       Roberto Bautista Agut 30.2 1933.3 NA 1853.5 1817.7 1793.2
## 16    16              Kevin Anderson 32.1 1916.5 NA 1834.2 1820.7 1631.0
## 17    17               Tomas Berdych 32.8 1910.9 NA 1877.2 1866.1 1760.7
## 18    18                 Hyeon Chung 22.0 1909.9 NA 1849.7 1775.2 1439.7
## 19    19 Diego Sebastian Schwartzman 25.8 1907.4 NA 1758.5 1864.3 1282.5
## 20    20                 Kyle Edmund 23.4 1905.9 NA 1800.5 1811.3 1401.1
## 21    21               Fabio Fognini 31.0 1897.2 NA 1814.4 1839.3 1626.6
## 22    22                  John Isner 33.1 1897.1 NA 1843.5 1792.6 1731.1
## 23    23             Richard Gasquet 32.0 1894.9 NA 1786.1 1819.9 1709.9
## 24    24          Jo Wilfried Tsonga 32.8 1879.6 NA 1810.3 1786.8 1632.3
## 25    25             Karen Khachanov 22.1 1875.7 NA 1734.6 1807.4 1688.2
## 26    26         Pablo Carreno Busta 26.9 1856.3 NA 1743.7 1779.7 1376.2
## 27    27       Philipp Kohlschreiber 34.7 1847.1 NA 1745.4 1823.5 1592.3
## 28    28               Lucas Pouille 24.3 1843.2 NA 1822.9 1735.0 1652.2
## 29    29                Gael Monfils 31.7 1842.3 NA 1839.6 1700.7 1526.4
## 30    30         Alexandr Dolgopolov 29.5 1836.6 NA 1760.6 1777.2 1635.1
## 31    31                David Ferrer 36.2 1832.8 NA 1794.1 1840.6 1558.9
## 32    32             Peter Gojowczyk 28.8 1828.5 NA 1725.1 1684.0 1580.1
## 33    33          Stanislas Wawrinka 33.2 1827.2 NA 1804.0 1850.5 1549.2
## 34    34             Feliciano Lopez 36.7 1822.7 NA 1695.9 1735.1 1801.6
## 35    35           Fernando Verdasco 34.6 1821.2 NA 1728.1 1805.9 1608.9
## 36    36               Steve Johnson 28.5 1821.2 NA 1669.8 1811.1 1638.4
## 37    37                 Sam Querrey 30.7 1820.7 NA 1744.2 1636.2 1783.1
## 38    38            Marco Cecchinato 25.7 1820.6 NA 1345.6 1781.0 1483.6
## 39    39               Jeremy Chardy 31.3 1815.7 NA 1712.9 1722.1 1673.7
## 40    40               Martin Klizan 28.9 1815.7 NA 1630.0 1807.8 1393.9
## 41    41              Radek Stepanek 38.1 1813.7 NA 1735.1 1661.2 1648.8
## 42    42            Marcos Baghdatis 32.9 1812.3 NA 1785.0 1503.0 1668.0
## 43    43            Marton Fucsovics 26.3 1811.3 NA 1602.3 1764.5 1430.7
## 44    44                Benoit Paire 29.1 1810.9 NA 1703.8 1714.8 1632.9
## 45    45            Filip Krajinovic 26.1 1810.4 NA 1790.1 1486.9 1476.8
## 46    46          Stefanos Tsitsipas 19.8 1809.8 NA 1575.8 1750.9 1527.0
## 47    47            Denis Shapovalov 19.2 1806.9 NA 1778.1 1747.9 1415.6
## 48    48              Leonardo Mayer 31.1 1801.2 NA 1698.1 1763.1 1560.5
## 49    49              Francis Tiafoe 20.4 1799.4 NA 1774.8 1543.2 1572.2
## 50    50                Gilles Simon 33.5 1798.7 NA 1738.8 1746.4 1618.1
## 51    51               Andrey Rublev 20.5 1797.5 NA 1710.0 1672.7 1544.3
## 52    52               Dusan Lajovic 27.9 1797.1 NA 1626.8 1764.5 1465.4
## 53    53             Nicolas Almagro 32.1 1793.8 NA 1645.6 1820.8 1505.2
## 54    54                Pablo Cuevas 32.4 1787.7 NA 1653.8 1777.9 1545.8
## 55    55            Julien Benneteau 36.5 1781.8 NA 1727.2 1553.4 1587.4
## 56    56                Steve Darcis 33.7 1779.5 NA 1695.3 1677.4 1594.4
## 57    57                   Jack Sock 25.7 1771.2 NA 1770.1 1684.6 1567.5
## 58    58               Damir Dzumhur 26.1 1769.0 NA 1770.4 1569.7 1502.7
## 59    59          Taylor Harry Fritz 20.6 1767.9 NA 1728.7 1618.0 1377.1
## 60    60                 Guido Pella 28.1 1763.4 NA 1625.0 1696.2 1510.0
## 61    61                Aljaz Bedene 28.9 1757.7 NA 1606.1 1722.2 1569.3
## 62    62                Albert Ramos 30.4 1753.4 NA 1605.8 1742.3 1533.1
## 63    63            Adrian Mannarino 30.0 1752.7 NA 1709.7 1521.9 1660.1
## 64    64               Andreas Seppi 34.3 1752.7 NA 1718.0 1659.6 1637.9
## 65    65                  Joao Sousa 29.2 1752.7 NA 1685.3 1698.1 1422.1
## 66    66             Daniil Medvedev 22.3 1751.4 NA 1740.7 1429.6 1662.5
## 67    67              Jerzy Janowicz 26.9 1750.6 NA 1669.9 1599.0 1645.4
## 68    68              Simone Bolelli 32.6 1743.7 NA 1563.0 1771.6 1600.7
## 69    69                John Millman 29.0 1743.5 NA 1697.2 1570.6 1473.9
## 70    70       Pierre Hugues Herbert 27.2 1738.6 NA 1649.2 1630.7 1498.1
## 71    71               Ryan Harrison 26.1 1737.8 NA 1717.5 1503.6 1371.2
## 72    72               Tommy Robredo 36.0 1737.6 NA 1684.0 1659.2 1480.6
## 73    73               Andrej Martin 28.4 1735.8 NA 1460.2 1723.2 1473.9
## 74    74               Nicolas Jarry 22.6 1734.5 NA 1499.1 1701.8 1459.8
## 75    75                 Robin Haase 31.2 1734.4 NA 1671.9 1630.3 1568.8
## 76    76              Viktor Troicki 32.2 1731.5 NA 1678.2 1674.6 1538.3
## 77    77               Bernard Tomic 25.6 1730.3 NA 1679.6 1499.0 1681.0
## 78    78           Federico Delbonis 27.6 1726.6 NA 1645.7 1719.6 1328.8
## 79    79                Malek Jaziri 34.4 1726.6 NA 1656.0 1686.8 1391.3
## 80    80          Thanasi Kokkinakis 22.0 1726.2 NA 1657.0 1492.7 1483.4
## 81    81                Ivo Karlovic 39.3 1725.4 NA 1675.1 1604.9 1684.4
## 82    82              Alex De Minaur 19.3 1725.1 NA 1680.5 1505.2 1500.0
## 83    83          Yoshihito Nishioka 22.7 1724.1 NA 1709.2 1450.9 1393.5
## 84    84                 Taro Daniel 25.3 1723.4 NA 1548.2 1673.1 1385.2
## 85    85               Mischa Zverev 30.8 1722.6 NA 1623.6 1608.0 1604.3
## 86    86         Maximilian Marterer 23.0 1720.9 NA 1622.0 1678.3 1389.7
## 87    87            Andrey Kuznetsov 26.6 1719.5 NA 1582.9 1713.2 1474.8
## 88    88               Denis Istomin 31.8 1718.4 NA 1666.8 1560.0 1644.8
## 89    89                Daniel Evans 28.1 1715.8 NA 1720.1 1527.3 1472.0
## 90    90               Jurgen Melzer 36.9 1712.3 NA 1653.9 1642.7 1623.4
## 91    91            Janko Tipsarevic 33.2 1712.3 NA 1705.3 1646.8 1607.9
## 92    92               Gilles Muller 35.1 1711.5 NA 1615.9 1524.4 1685.9
## 93    93               Nicolas Mahut 36.3 1708.8 NA 1640.2 1549.7 1683.6
## 94    94               Pablo Andujar 32.3 1707.4 NA 1459.9 1751.5 1306.9
## 95    95                 Yen Hsun Lu 34.1 1706.6 NA 1636.5 1439.3 1585.8
## 96    96               Matthew Ebden 30.6 1703.3 NA 1540.5 1333.4 1627.8
## 97    97                 Lukas Rosol 32.8 1701.5 NA 1620.9 1658.2 1439.8
## 98    98             Jared Donaldson 21.7 1699.9 NA 1685.6 1516.2 1391.0
## 99    99          Jan Lennard Struff 28.1 1699.4 NA 1621.8 1645.7 1346.9
## 100  100                  Tommy Haas 39.3 1698.6 NA 1602.7 1636.5 1513.1
## 101  101                 Jiri Vesely 24.9 1694.4 NA 1578.5 1702.3 1543.7
## 102  102     Roberto Carballes Baena 25.2 1692.7 NA 1412.8 1685.3 1500.0
## 103  103            Horacio Zeballos 33.1 1692.0 NA 1591.2 1667.6 1209.1
## 104  104             Albert Montanes 36.4 1691.8 NA 1480.6 1698.8 1419.9
## 105  105              Ernests Gulbis 29.7 1690.1 NA 1594.7 1712.2 1520.6
## 106  106             Henri Laaksonen 26.0 1687.6 NA 1601.1 1614.4 1422.2
## 107  107      Guillermo Garcia Lopez 35.0 1686.9 NA 1568.9 1708.5 1427.3
## 108  108                   Dudi Sela 33.1 1684.5 NA 1647.7 1328.3 1609.6
## 109  109           Ricardo Rodriguez 24.9 1679.8 NA 1718.0 1542.9 1500.0
## 110  110                 Mirza Basic 26.9 1678.7 NA 1772.1 1458.9 1477.4
## 111  111           Sergiy Stakhovsky 32.4 1675.4 NA 1597.1 1508.8 1596.5
## 112  112           Mikhail Kukushkin 30.4 1672.3 NA 1631.5 1559.5 1455.7
## 113  113                Yuki Bhambri 25.9 1671.8 NA 1647.3 1452.9 1471.9
## 114  114                  Ivan Dodig 32.5 1671.0 NA 1523.2 1732.8 1578.4
## 115  115                Donald Young 28.7 1668.4 NA 1615.2 1434.3 1523.3
## 116  116                Dustin Brown 33.3 1664.3 NA 1581.0 1556.9 1581.1
## 117  117           Ricardas Berankis 27.9 1663.6 NA 1647.2 1388.5 1229.1
## 118  118              Evgeny Donskoy 28.1 1663.4 NA 1607.0 1385.5 1437.1
## 119  119               Florian Mayer 34.7 1656.8 NA 1568.7 1601.9 1702.6
## 120  120             Ruben Bemelmans 30.4 1656.1 NA 1568.5 1421.1 1479.9
## 121  121                 Darian King 25.9 1652.5 NA 1621.9 1405.3 1500.0
## 122  122                 Denis Kudla 25.8 1652.4 NA 1476.6 1477.7 1562.7
## 123  123             Thomaz Bellucci 30.4 1652.3 NA 1602.5 1629.7 1401.0
## 124  124                Tobias Kamke 31.2 1651.0 NA 1560.5 1629.9 1521.7
## 125  125               Yuichi Sugita 29.7 1648.6 NA 1595.8 1426.8 1603.4
## 126  126                Marius Copil 27.6 1647.0 NA 1671.2 1468.0 1497.5
## 127  127        Nikoloz Basilashvili 26.3 1646.7 NA 1616.9 1601.3 1465.0
## 128  128             Mikhail Youzhny 36.0 1645.0 NA 1639.7 1512.0 1588.8
## 129  129           Marcel Granollers 32.0 1642.8 NA 1569.9 1615.1 1458.1
## 130  130                 Casper Ruud 19.4 1639.0 NA 1452.5 1612.5 1500.0
## 131  131              Vasek Pospisil 28.0 1638.5 NA 1631.8 1263.2 1471.2
## 132  132               Jozef Kovalik 25.6 1636.3 NA 1648.6 1468.4 1471.3
## 133  133            Thiemo De Bakker 29.4 1632.1 NA 1540.1 1669.8 1463.6
## 134  134              Carlos Berlocq 35.1 1628.0 NA 1574.2 1599.6 1333.8
## 135  135          Paul Henri Mathieu 35.7 1626.0 NA 1529.3 1659.1 1553.2
## 136  136                  Rajeev Ram 33.3 1625.3 NA 1546.5 1563.0 1544.6
## 137  137            Santiago Giraldo 30.5 1621.0 NA 1521.3 1617.3 1476.5
## 138  138             Tennys Sandgren 26.9 1620.3 NA 1607.0 1473.8 1444.8
## 139  139         Ramkumar Ramanathan 23.4 1616.2 NA 1517.4 1500.0 1525.2
## 140  140            Bjorn Fratangelo 24.8 1611.7 NA 1484.4 1579.9 1579.3
## 141  141             Alejandro Falla 33.2 1609.0 NA 1559.8 1563.2 1514.2
## 142  142                Samuel Groth 29.7 1607.6 NA 1451.5 1505.2 1560.5
## 143  143               Reilly Opelka 20.5 1607.4 NA 1593.3 1441.2 1423.7
## 144  144               Paolo Lorenzi 36.4 1603.9 NA 1539.4 1592.4 1264.4
## 145  145                  Radu Albot 28.5 1603.0 NA 1483.5 1521.6 1542.2
## 146  146              Nicolas Kicker 25.8 1602.5 NA 1549.3 1553.6 1463.6
## 147  147                 Laslo Djere 23.0 1600.3 NA 1410.4 1647.3 1500.0
## 148  148                Gastao Elias 27.4 1597.9 NA 1371.4 1652.9 1387.2
## 149  149            Ernesto Escobedo 21.8 1596.1 NA 1586.4 1471.3 1429.8
## 150  150             Thiago Monteiro 23.9 1595.7 NA 1458.1 1582.7 1518.1
## 151  151         Rogerio Dutra Silva 34.3 1593.9 NA 1468.3 1579.1 1299.8
## 152  152                 Lukas Lacko 30.6 1593.8 NA 1557.1 1390.5 1393.3
## 153  153                    Go Soeda 33.1 1582.3 NA 1516.8 1465.7 1369.1
## 154  154             Illya Marchenko 29.9 1582.0 NA 1560.6 1411.4 1332.0
## 155  155                 Renzo Olivo 26.0 1578.8 NA 1404.2 1566.7 1442.2
## 156  156                    Ze Zhang 27.7 1578.6 NA 1472.2 1569.0 1503.8
## 157  157             Thomas Fabbiano 29.0 1574.8 NA 1455.8 1421.9 1481.7
## 158  158             Stephane Robert 37.1 1569.8 NA 1492.4 1575.5 1407.9
## 159  159                Ilya Ivashka 24.3 1566.7 NA 1641.9 1452.2 1500.0
## 160  160           Kenny De Schepper 30.7 1565.3 NA 1536.9 1403.7 1479.0
## 161  161               Gerald Melzer 27.8 1560.0 NA 1362.5 1600.9 1500.0
## 162  162                Marsel Ilhan 30.9 1556.0 NA 1571.4 1413.2 1400.9
## 163  163                 Blaz Kavcic 31.1 1550.7 NA 1488.7 1516.0 1311.6
## 164  164             Jordan Thompson 24.1 1545.1 NA 1520.7 1462.3 1416.0
## 165  165                  Elias Ymer 22.1 1543.7 NA 1414.2 1530.4 1472.0
## 166  166             Victor Estrella 37.6 1538.6 NA 1444.4 1632.7 1385.5
## 167  167                 Tim Smyczek 30.5 1535.8 NA 1509.4 1430.8 1367.5
## 168  168                       Di Wu 26.5 1528.0 NA 1490.9 1408.6 1397.2
## 169  169               Quentin Halys 21.3 1516.6 NA 1460.1 1431.9 1500.0
## 170  170          Alejandro Gonzalez 29.1 1502.9 NA 1492.5 1416.3 1383.2
## 171  171              Facundo Bagnis 28.0 1494.8 NA 1427.7 1504.9 1374.9
## 172  172                  Joao Souza 28.8 1475.8 NA 1398.4 1451.1 1435.1
## 173  173         Konstantin Kravchuk 32.6 1420.9 NA 1278.3 1590.5 1381.0
## 174  174              Norbert Gombos 27.6 1418.8 NA 1395.1 1397.1 1442.3
##                           Peak Match Peak Age Peak Elo
## 1   NA         2009 Madrid Masters F     22.9   2388.4
## 2   NA 2007 Indian Wells Masters R64     25.6   2405.7
## 3   NA  2016 Monte Carlo Masters R32     28.9   2459.9
## 4   NA                2009 Tokyo R32     21.0   2256.6
## 5   NA   2017 Cincinnati Masters R32     20.3   2136.8
## 6   NA                   2017 Doha F     29.6   2334.7
## 7   NA                 2016 Halle SF     22.8   2116.5
## 8   NA                 2010 Dubai QF     21.4   2110.6
## 9   NA           2017 Monte Carlo SF     26.4   2034.6
## 10  NA               2016 Us Open SF     26.7   2201.9
## 11  NA        2014 Canada Masters SF     23.2   2099.1
## 12  NA                  2018 Halle F     21.6   1943.1
## 13  NA     2017 Cincinnati Masters F     22.3   2081.9
## 14  NA              2016 Wimbledon F     25.5   2144.4
## 15  NA             2016 Rotterdam QF     27.8   2020.2
## 16  NA      2015 Shanghai Masters QF     29.4   2004.6
## 17  NA  2013 Indian Wells Masters SF     27.5   2129.7
## 18  NA         2018 Miami Masters QF     21.8   1958.4
## 19  NA             2018 Acapulco R16     25.5   1942.4
## 20  NA       2018 Australian Open SF     23.0   1935.4
## 21  NA  2014 Monte Carlo Masters R16     26.9   2014.3
## 22  NA              2012 US Open R32     27.3   2045.5
## 23  NA              2007 Adelaide QF     20.5   2046.8
## 24  NA 2009 Indian Wells Masters R32     23.9   2170.8
## 25  NA                2017 Bastad QF     21.2   1907.2
## 26  NA                2016 Basel R16     25.3   1933.7
## 27  NA            2009 Stuttgart R16     25.7   2002.3
## 28  NA              2016 Beijing R16     22.6   1996.1
## 29  NA          2010 Paris Masters F     24.2   2061.4
## 30  NA        2011 Costa Do Sauipe F     22.3   1963.2
## 31  NA               2013 Acapulco F     30.9   2214.9
## 32  NA           2018 Delray Beach F     28.6   1892.3
## 33  NA      2016 Australian Open R16     30.8   2136.5
## 34  NA             2005 Marseille SF     23.4   1959.0
## 35  NA          2010 Rome Masters SF     26.4   2109.1
## 36  NA    2016 Cincinnati Masters QF     26.6   1926.9
## 37  NA         2012 Paris Masters QF     25.1   1959.1
## 38  NA         2018 Roland Garros SF     25.7   1832.0
## 39  NA                2009 Gstaad QF     22.5   1929.8
## 40  NA             2015 Barcelona SF     25.8   1895.6
## 41  NA         2009 Paris Masters SF     31.0   2021.8
## 42  NA  2006 Indian Wells Masters QF     20.7   2026.2
## 43  NA        2018 Roland Garros R64     26.3   1835.6
## 44  NA                  2015 Tokyo F     26.4   1904.7
## 45  NA        2018 Miami Masters R16     26.1   1817.7
## 46  NA               2018 Estoril SF     19.7   1917.8
## 47  NA        2018 Roland Garros R64     19.1   1919.4
## 48  NA        2014 Winston-Salem R32     27.3   1882.1
## 49  NA                2018 Estoril F     20.3   1884.8
## 50  NA            2009 Rotterdam R16     24.1   2031.2
## 51  NA             2018 Rotterdam QF     20.3   1925.8
## 52  NA        2018 Roland Garros R64     27.9   1801.8
## 53  NA                2012 Tokyo R32     27.1   2040.2
## 54  NA                2016 Hamburg F     30.5   1900.0
## 55  NA              2013 Rotterdam F     31.1   1903.2
## 56  NA         2012 Winston-Salem QF     28.4   1890.5
## 57  NA  2017 Indian Wells Masters SF     24.4   2032.3
## 58  NA              2017 Shenzhen SF     25.3   1926.7
## 59  NA                  2018 Lyon QF     20.6   1849.9
## 60  NA 2016 Indian Wells Masters R32     25.8   1807.4
## 61  NA              2018 Budapest SF     28.8   1841.0
## 62  NA             2017 Barcelona QF     29.3   1879.3
## 63  NA      2018 Australian Open R32     29.5   1876.3
## 64  NA             2005 Stuttgart QF     21.4   1903.4
## 65  NA      2016 Australian Open R32     26.8   1859.9
## 66  NA            2017 Washington QF     21.5   1920.4
## 67  NA       2013 Canada Masters R16     22.7   1959.1
## 68  NA        2008 Roland Garros R32     22.6   1933.3
## 69  NA         2016 Winston-Salem SF     27.2   1872.4
## 70  NA          2015 Winston-Salem F     24.4   1804.9
## 71  NA 2012 Indian Wells Masters R16     19.8   1827.5
## 72  NA         2009 Roland Garros QF     27.1   1995.7
## 73  NA                 2018 Quito SF     28.4   1773.2
## 74  NA              2018 Sao Paulo F     22.4   1831.2
## 75  NA                2008 Zagreb QF     20.9   1865.9
## 76  NA   2011 Monte Carlo Masters QF     25.2   2001.7
## 77  NA      2012 Australian Open R16     19.2   1941.7
## 78  NA                2013 Hamburg F     22.8   1852.8
## 79  NA        2017 Miami Masters R32     33.2   1804.3
## 80  NA              2017 Los Cabos F     21.3   1762.6
## 81  NA        2007 Paris Masters R32     28.7   2002.1
## 82  NA                 2018 Sydney F     18.9   1841.7
## 83  NA      2018 Australian Open R64     22.3   1841.8
## 84  NA               2018 Istanbul F     25.3   1695.8
## 85  NA       2017 Australian Open QF     29.4   1839.3
## 86  NA            2018 Stuttgart R16     23.0   1777.2
## 87  NA                2016 Geneva QF     25.2   1880.3
## 88  NA            2014 Wimbledon R32     27.8   1851.7
## 89  NA      2017 Australian Open R16     26.7   1880.6
## 90  NA         2010 Paris Masters QF     29.5   1967.4
## 91  NA               2012 Bangkok SF     28.3   2055.8
## 92  NA             2017 Wimbledon QF     34.2   1986.9
## 93  NA                  2007 Metz SF     25.7   1888.7
## 94  NA            2012 Barcelona R32     26.2   1804.9
## 95  NA 2014 Indian Wells Masters R32     30.6   1804.2
## 96  NA 2012 Indian Wells Masters R16     24.3   1853.5
## 97  NA         2013 Rome Masters R64     27.8   1877.4
## 98  NA               2017 Chengdu QF     21.0   1833.5
## 99  NA                2017 Vienna QF     27.5   1798.0
## 100 NA       2002 Australian Open SF     23.8   2122.4
## 101 NA        2017 Roland Garros R32     23.9   1841.3
## 102 NA         2018 Buenos Aires R32     24.9   1749.3
## 103 NA               2010 Houston SF     24.9   1794.2
## 104 NA              2001 Bucharest F     20.8   1901.5
## 105 NA         2014 Roland Garros SF     25.7   2048.3
## 106 NA              2017 Antwerp R16     25.5   1754.3
## 107 NA      2010 Shanghai Masters QF     27.4   1882.2
## 108 NA               2009 Memphis SF     23.9   1860.1
## 109 NA          2014 Davis Cup G1 R1     20.8   1708.3
## 110 NA       2018 Miami Masters R128     26.7   1863.7
## 111 NA         2010 Kuala Lumpur R16     24.7   1910.3
## 112 NA                 2011 Doha R32     23.0   1917.8
## 113 NA        2018 Miami Masters R64     25.7   1742.2
## 114 NA             2011 Barcelona SF     26.3   1954.0
## 115 NA        2017 Miami Masters R16     27.7   1852.3
## 116 NA         2017 Delray Beach R32     32.2   1825.4
## 117 NA          2013 Delray Beach QF     22.7   1850.9
## 118 NA                2015 Moscow SF     25.4   1704.3
## 119 NA        2011 Roland Garros R64     27.6   1941.0
## 120 NA               2017 Antwerp SF     29.8   1745.6
## 121 NA          2018 Davis Cup G1 R1     25.8   1792.1
## 122 NA               2015 Atlanta SF     22.9   1736.7
## 123 NA               2010 Hamburg QF     22.6   1934.6
## 124 NA               2014 Hamburg QF     28.1   1731.7
## 125 NA    2017 Cincinnati Masters QF     28.9   1826.7
## 126 NA       2015 s-Hertogenbosch QF     24.6   1758.3
## 127 NA        2017 Roland Garros R32     25.3   1842.9
## 128 NA                  2007 Dubai F     24.7   2031.8
## 129 NA               2012 Sydney R32     25.7   1917.6
## 130 NA        2017 Rio De Janeiro SF     18.2   1673.9
## 131 NA              2015 Valencia SF     25.3   1851.1
## 132 NA                 2018 Sofia SF     25.3   1661.8
## 133 NA             2010 New Haven SF     21.9   1887.3
## 134 NA                  2014 Nice QF     31.3   1848.4
## 135 NA           2002 Davis Cup WG F     20.9   2038.9
## 136 NA            2009 New Haven R16     25.4   1794.3
## 137 NA               2012 Munich R16     24.4   1868.9
## 138 NA                2018 Houston F     26.7   1725.2
## 139 NA               2017 Antalya QF     22.6   1681.0
## 140 NA              2017 Us Open R64     24.1   1692.2
## 141 NA            2006 Wimbledon R64     22.6   1804.0
## 142 NA        2015 Winston-Salem R32     27.8   1805.2
## 143 NA              2017 Memphis R16     19.5   1707.5
## 144 NA              2017 Budapest SF     35.4   1758.3
## 145 NA          2015 Davis Cup G2 R1     25.3   1699.9
## 146 NA               2017 Hamburg QF     24.9   1763.4
## 147 NA               2017 Moscow R16     22.4   1736.2
## 148 NA             2016 Olympics R32     25.7   1711.6
## 149 NA               2017 Houston SF     20.8   1750.4
## 150 NA                2016 Gstaad QF     22.1   1776.1
## 151 NA             2013 Santiago R32     29.0   1678.5
## 152 NA                 2012 Zagreb F     24.2   1804.9
## 153 NA          2012 Davis Cup WG R1     27.4   1747.5
## 154 NA        2010 Miami Masters R64     22.5   1835.1
## 155 NA                 2016 Quito QF     23.9   1732.4
## 156 NA             2016 Shenzhen R32     26.2   1615.5
## 157 NA                2016 Dubai R16     26.7   1592.5
## 158 NA           2010 Casablanca R16     29.9   1789.2
## 159 NA                 2018 Pune R16     23.9   1696.0
## 160 NA            2013 Wimbledon R16     26.1   1616.8
## 161 NA                 2018 Quito QF     27.6   1647.7
## 162 NA            2010 Rotterdam R16     22.7   1716.7
## 163 NA        2011 Roland Garros R64     24.2   1727.8
## 164 NA              2017 Us Open R64     23.4   1744.8
## 165 NA            2015 Barcelona R16     19.0   1610.5
## 166 NA                2015 Munich QF     34.7   1848.4
## 167 NA              2013 US Open R32     25.7   1722.2
## 168 NA             2015 Shenzhen R32     24.0   1710.2
## 169 NA        2016 Roland Garros R64     19.6   1586.5
## 170 NA               2014 Houston QF     25.2   1667.6
## 171 NA             2016 Marrakech QF     26.1   1628.2
## 172 NA              2010 Santiago SF     21.7   1709.4
## 173 NA       2010 St. Petersburg R16     25.7   1609.9
## 174 NA          2014 Davis Cup G1 R2     23.6   1597.1
```

---

# Handling Dynamic Data 

- Because dynamic data is created on-the-fly we can't simply read from the HTML to get those data

--

- There are &lt;b&gt;two&lt;/b&gt; main ways we can deal with this:

  1. Sleuth the underlying data objects
  
  2. Use automated browsing to make the dynamic problem a static problem

---

# Sleuthing

.pull-left[
- Dynamic data has to come from somewhere. 

- Usually data is stored in a server and made available to JS functions via JSON/XML files.

- If we can find and access those data files, our scraping dilemma is essentially solved.
]

.pull-right[
![](inspector_gadget.gif)
]

---

# Sleuth Principles

1. If data is dynamic, fire up "Developer Tools"

2. Select XHR for (XML HTTP Request) [This is where events happen]

3. Make an event by selecting the data of interest

4. Review requests and look for JSON/XML content in the "Response" field

---

# Example: World Cup Data

![](football_world_cup.png)


---


# Example: World Cup Data

![](football_xhr.png)

---

# Importing the Data

With a URL location for the data file, JSON in this case, we can easily read in these data to R.


```r
library(jsonlite) # Reading JSON files

url &lt;- "https://www.sofascore.com/tournament/3958/15586/standings/tables/json?"

data &lt;- fromJSON(url)

data$teamEvents[[1]]$total
```

```
##        id customId homeTeam.id homeTeam.name awayTeam.id awayTeam.name
## 1 7659866  gVbsfCc        4756    Costa Rica        6355        Serbia
## 2 7659881  ZTbsfCc        6355        Serbia        4699   Switzerland
## 3 7659890  YUbsfCc        6355        Serbia        4748        Brazil
##   current current winnerCode               slug startTimestamp
## 1       0       1          2  serbia-costa-rica     1529236800
## 2       1       2          2 serbia-switzerland     1529690400
## 3       0       2          2      serbia-brazil     1530122400
```

---

# XHR Patterns

Using the XHR info to get at the data objects behind dynamic pages, the scraping problem largely reduces to:

1. Identifying patterns in the XHR
2. Parsing the resulting objects

--

What do I mean by XHR pattern? Consider our Brazil example...what if we want another WC group?


```r
url &lt;- "https://www.sofascore.com/tournament/GROUP/15586/standings/tables/json?"

data &lt;- fromJSON(sub("GROUP", 3959, url))

data$teamEvents[[1]]$total
```

```
##        id customId homeTeam.id homeTeam.name awayTeam.id awayTeam.name
## 1 7659878  NTbsKUb        4688        Sweden        4735   South Korea
## 2 7659888  KUbsGVb        4735   South Korea        4781        Mexico
## 3 7659904  lUbsKUb        4735   South Korea        4711       Germany
##   current current winnerCode                slug startTimestamp
## 1       1       0          1  south-korea-sweden     1529323200
## 2       1       2          2  mexico-south-korea     1529766000
## 3       2       0          1 south-korea-germany     1530108000
```


---


# Automated Browsing

- Sadly, many dynamic sites will hide their backend data

--

- But we can still deal with this!

--

- We just need to find what instructions to give to mimic the browsing that generates the data and get familiar with tools that can implement these instructions


---



# RSelenium

--

- _Selenium_ is software that allows automated Web browsing

--

- [RSelenium](https://cran.r-project.org/web/packages/RSelenium/index.html) is a package that provides Selenium functionality in R

![](selenium_rc.png)

---



# RSelenium Installation

- Although you can install and run RSelenium locally, you can save yourself a lot of pain by using RSelenium through _docker_.

- Once _docker_ is installed there are many images available that are already setup with Selenium : https://hub.docker.com/u/selenium/

![](docker.png)

---



# RSelenium: Basic Steps

1. Set the Web driver (select browser and port)

2. Find the elements with the data

3. Extract the content

4. Parse the contents

---



# Setting Up Docker

1. We will use the `selenium/standalone-firefox` docker image in our examples

2. Once docker is running, we can initiate this image on port 4445 with the code shown at the bottom. 

3. We can now use RSelenium on port 4445



```r
docker run -d -p 4445:4444 selenium/standalone-firefox
```

---


# Example: Tennis Match Statistics

Consider the following match summary: [2017 Australian Open Final](http://www.flashscore.com/match/Cj6I5iL9/#match-statistics;0)


![](aus-open-final.png)

---




# Example: Tennis Match Statistics

If we inspect the page, we find that these stats are dynamic data. We also find that the main table of content has the id `detail`.

![](aus-open-inspect.png)


---

# Using RSelenium

Below we activate the driver on the designated docker port (using `L` to ensure it is treated as an integer)


```r
library(RSelenium) # Load the package

# Match statistics URL
url &lt;- "http://www.flashscore.com/match/Cj6I5iL9/#match-statistics;0"

# Open driver
remDr &lt;-remoteDriver(port = 4445L)

remDr$open()

remDr$navigate(url) # Navigate page
```

---

# Using RSelenium

Next we extract the table of stats using the CSS `id` node.


```r
# Get id element
webElem &lt;- remDr$findElements(using = 'id', "detail")

#  Use getElementText to extract the text from this element
unlist(lapply(webElem, function(x){x$getElementText()}))[[1]]

remDr$close() # Close driver when finished
```

---

# Practice: RSelenium

Take a look at the NFL Standings at: https://www.nfl.com/standings


&lt;div style="margin-left: 15%;"&gt;
&lt;img src="nfl_standings.png" width="80%" /&gt;
&lt;/div&gt;


---



# Practice: RSelenium

Use what we've covered about `RSelenium` to extract the statistics for the American Football Conference teams.

1. Start by inspecting the Web site

2. Determine which CSS element is most likely to contain the stats (Hint: search for 'American Football Conference')

3. Create a remote driver, navigate to that element, and check if the text includes the numbers from the standings table.

---


# Solution: RSelenium

Inspection of the source code suggests that the Element with `class` *rsv-ae9db127* is likely to contain the statistics.

Now we navigate to the site.


```r
url &lt;- "https://www.nfl.com/standings"


# Establish remote driver (using Firefox by default)
remDr &lt;-remoteDriver(port = 4445L)
remDr$open(silent = TRUE) # Supress any output messages
remDr$navigate(url) # Navigate page
```

---


# Solution: RSelenium

Then we find the `class` element of interest and extract the text it contains.


```r
# Get id element

webElem &lt;- remDr$findElements(using = "class", 
    "rsv-ae9db127")

# Use getElementText to extract
# the text from this element
unlist(lapply(webElem, function(x) {
    x$getElementText()
}))[29:35]
```

```
## [1] "Miami\nDolphins"       "New England\nPatriots" "New England\nPatriots"
## [4] "New England\nPatriots" "New York\nJets"        "New York\nJets"       
## [7] "New York\nJets"
```



---



# Summary

- Web data can be classed into three main categories: directly importable, static, or dynamic

- We can use Web developer tools to determine which data type we are working with and the site elements that contain the data

- We have seen how we use tools like `rvest` to capture static Web data

- For dynamic data, we can use automated browsing with `RSelenium` 

---


# Resources

- [XPATH: https://www.w3schools.com/xml/xpath_intro.asp](https://www.w3schools.com/xml/xpath_intro.asp)

- [rvest: https://www.r-bloggers.com/rvest-easy-web-scraping-with-r/](https://www.r-bloggers.com/rvest-easy-web-scraping-with-r/)

- [RSelenium: https://ropensci.org/tutorials/rselenium_tutorial.html](https://ropensci.org/tutorials/rselenium_tutorial.html)

- [docker: https://ropenscilabs.github.io/r-docker-tutorial/](https://ropenscilabs.github.io/r-docker-tutorial/)
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
